{{- if .Values.langflow.enabled -}}
# -----------------------------------------------------------------------------
# Persistent Volume Claims (Storage)
# -----------------------------------------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: langflow-flows-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.langflow.persistence.flows.size }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: langflow-logs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.langflow.persistence.logs.size }}

---
# -----------------------------------------------------------------------------
# Service (Network)
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: langflow
spec:
  type: {{ .Values.langflow.service.type }}
  selector:
    app: langflow
  ports:
    - protocol: TCP
      port: {{ .Values.langflow.service.port }}
      targetPort: {{ .Values.langflow.service.targetPort }}
      {{- if and (eq .Values.langflow.service.type "NodePort") .Values.langflow.service.nodePort }}
      nodePort: {{ .Values.langflow.service.nodePort }}
      {{- end }}

---
# -----------------------------------------------------------------------------
# Deployment (Application)
# -----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: langflow
  labels:
    app: langflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: langflow
  template:
    metadata:
      labels:
        app: langflow
    spec:
      containers:
        - name: langflow
          image: "{{ .Values.global.registry }}/{{ .Values.langflow.image.repository }}:{{ .Values.langflow.image.tag }}"
          imagePullPolicy: {{ .Values.langflow.image.pullPolicy }}

          envFrom:
            - configMapRef:
                name: langflow-config
          env:
            - name: LANGFLOW_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: tis-app-secrets
                  key: langflow-secret-key
            - name: LANGFLOW_SUPERUSER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tis-app-secrets
                  key: langflow-superuser-password
            - name: LANGFLOW_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tis-app-secrets
                  key: langflow-password
            - name: POSTGRES_DB_NAME
              valueFrom:
                configMapKeyRef:
                  name: langflow-config
                  key: POSTGRES_DB_NAME
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: POSTGRES_USER
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: POSTGRES_PORT
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tis-app-secrets
                  key: postgres-password
            - name: LANGFLOW_DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB_NAME)"

          command: [ "/bin/sh", "-lc" ]
          args:
            - >
              exec /app/.venv/bin/python -m langflow run
              --host 0.0.0.0
              --port ${LANGFLOW_PORT:-7860}
              --workers ${WEB_CONCURRENCY:-1}
              --log-level ${LANGFLOW_LOG_LEVEL:-info}
          ports:
            - containerPort: {{ .Values.langflow.service.targetPort }}
              protocol: TCP

          readinessProbe:
            httpGet:
              path: /docs
              port: {{ .Values.langflow.service.targetPort }}
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

          volumeMounts:
            - name: flows-data
              mountPath: /app/flows
            - name: logs-data
              mountPath: /app/logs
            {{- if .Values.langflow.externalFiles.components.enabled }}
            - name: tis-components
              mountPath: /app/tis_components
            {{- end }}

            {{- if .Values.langflow.externalFiles.initScripts.enabled }}
            - name: init-scripts-python
              mountPath: /app/init/python
            {{- end }}

      volumes:
        - name: flows-data
          persistentVolumeClaim:
            claimName: langflow-flows-pvc
        - name: logs-data
          persistentVolumeClaim:
            claimName: langflow-logs-pvc
        {{- if .Values.langflow.externalFiles.components.enabled }}
        - name: tis-components
          hostPath:
            path: "{{ .Values.langflow.externalFiles.hostPathRoot }}/{{ .Values.langflow.externalFiles.components.path }}/"
            type: Directory
        {{- end }}
        {{- if .Values.langflow.externalFiles.initScripts.enabled }}
        - name: init-scripts-python
          hostPath:
            path: "{{ .Values.langflow.externalFiles.hostPathRoot }}/{{ .Values.langflow.externalFiles.initScripts.path }}/"
            type: Directory
        {{- end }}
  {{- end }}
